# 消息队列

**消息队列场景：**

- **异步：**业务链路很长，把步骤优化成异步。

- **解耦：**异步可以用线程池实现，但需要添加业务代码。将消息发送出去，新增其他业务时只需订阅消息即可。
- **削峰：**请求放在消息队列里，服务器按处理能力消费。

### 发布/订阅模型

消息实际是写入`Topic`某个队列中，消费组中的某个消费者对应消费一个队列的消息。

在物理上除了副本拷贝之外，一条消息在`Broker`中只会有一份，每个消费组会有自己的`offset`即消费点位来标识消费到的位置。在消费点位之前的消息表明已经消费过了。当然这个`offset`是队列级别的。每个消费组都会维护订阅的`Topic`下的每个队列的`offset`。

![图片](https://mmbiz.qpic.cn/mmbiz_png/azicia1hOY6Q9ic077HnPNN4qjjtPunia79BK3kBd4omH1H0ttk6N6OQNLPx48Eo6wt2GMEABCbU7j0O8cSGibgAWWQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 如何保证消息不丢失？

![图片](https://mmbiz.qpic.cn/mmbiz_png/azicia1hOY6Q9ic077HnPNN4qjjtPunia79B69l8rs7dznN6mg0YeCdZdAj9pWGTTr2rZbWy50OyB0f5iaFdM7RS5VA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**生产消息：**生产者发送消息至`Broker`，需要处理`Broker`的响应，不论是同步还是异步发送消息，都需要处理响应，如果`Broker`返回写入失败等错误消息，需要重试发送。当多次发送失败需要作报警，日志记录等。

**存储消息：**存储消息阶段需要在**消息刷盘之后**再给生产者响应。如果`Broker`是集群部署，有多副本机制，即消息不仅仅要写入当前`Broker`,还需要写入副本机中（配置至少几台）。

**消费消息：**消费者拿到消息，存入内存，执行完业务逻辑后，再告诉`Broker`消费成功。

### 如何处理重复消息

无法避免重复发送消息。订阅消息队列的多个业务模块中，一个失败了会要求重发消息，那其他订阅者如何避免重复消费呢？

实现**幂等**（多次执行，结果都是一样的）。幂等**分场景去考虑**，看是**强校验**还是**弱校验**。

**强校验：**比如钱的场景，加钱的接口，下面再调用一个加流水的接口，**两个放在一个事务**，每次消息过来都拿着订单号+业务场景等生成的唯一标识去流水表查，没有再执行后面的逻辑。

**弱校验：**不重要场景，比如发短信。把id+场景生成唯一key放到redis里，失效时间看场景。



## 参考

https://mp.weixin.qq.com/s/OKon95MRUqDc9IwtEqPSjQ